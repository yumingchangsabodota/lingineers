{% extends "header.html" %}

{% block content %}
{% csrf_token %}
<p>Vowel Chart</p>
<p id = 'formants'>{{formants}}</p>
<p id = 'x_y'>{{x_y}}</p>

<button type="button" id="startFormantAnalysis" class="btn btn-primary" data-toggle="modal" data-target="#modal_a">Start Formant Analysis</button>

<button type="button" id="toFormant">toFormant</button>
<p id='stat_text'></p>
<p id='formant_text'></p>

<canvas id="myChart" width="1200" height="600"></canvas>

<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.8.0/p5.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.8.0/addons/p5.sound.js"></script>
{% load staticfiles %}

{% if vowel_list_action %} 
<script>
	var vowels_recording_blobs = []

</script>
	{% for vowel in vowel_list_action %}
		{% include 'modals/vowelchart/record_audio.html' %}
	{% endfor%}
{%endif%}

<script type="text/javascript">


	$(document).ready(function(){
		var endpoint = /get-formants/
		var formants = '{{formants}}'

		$.ajax({
			method:'GET',
			url: endpoint,
				success: function(data){
					var ctx = document.getElementById("myChart");
					var data = {labels: data.labels,
								datasets: [{label: 'Vowel Chart',data: data.data}]
								};

		Chart.pluginService.register({
			beforeRender: function (chart) {
				if (chart.config.options.showAllTooltips) {
					// create an array of tooltips
					// we can't use the chart tooltip because there is only one tooltip per chart
					chart.pluginTooltips = [];
					chart.config.data.datasets.forEach(function (dataset, i) {
						chart.getDatasetMeta(i).data.forEach(function (sector, j) {
							chart.pluginTooltips.push(new Chart.Tooltip({
								_chart: chart.chart,
								_chartInstance: chart,
								_data: chart.data,
								_options: chart.options.tooltips,
								_active: [sector]
							}, chart));
						});
					});
					
					// turn off normal tooltips
					chart.options.tooltips.enabled = false;
				}
			},
			afterDraw: function (chart, easing) {
				if (chart.config.options.showAllTooltips) {
					// we don't want the permanent tooltips to animate, so don't do anything till the animation runs atleast once
					if (!chart.allTooltipsOnce) {
						if (easing !== 1)
							return;
						chart.allTooltipsOnce = true;
					}
					// turn on tooltips
					chart.options.tooltips.enabled = true;
					Chart.helpers.each(chart.pluginTooltips, function (tooltip) {
						tooltip.initialize();
						tooltip.update();
						// we don't actually need this since we are not animating tooltips
						tooltip.pivot();
						tooltip.transition(easing).draw();
					});
					chart.options.tooltips.enabled = false;
				}
			}
		});
					var scatterChart = new Chart(ctx, {
										type: 'scatter',
									    data: data,
									    options: {
									    	showAllTooltips: true,
									    	responsive: false,
									        scales: {
									            xAxes: [{
									                type: 'linear',
									                position: 'top',
									                ticks:{
									                	beginAtZero: true,
									                	reverse: true,
									                	suggestedMin: 0,
									                	suggestedMax: 3000
									                }
									            }],
									            yAxes:[{
									                type: 'linear',
									                position: 'right',
									                ticks:{
									                	beginAtZero: true,
									                	reverse: true,
									                	suggestedMin: 0,
									                	suggestedMax: 1000
									                }
									                
									            }]
									        },
									        layout:{
									        	padding:{
									        		left:300,
									        		bottom: 50
									        	}
									        },
									        tooltips:{
									        	displayColors: false,
										     	callbacks:{
										     		label: function(tooltipItem, data) {
										            var label = data.labels[tooltipItem.index];
													//return label + ', F1 - ' + tooltipItem.yLabel + '    F2 - ' + tooltipItem.xLabel + ')';
													return label
     														}
     													}

    												},
										}
						});
				},
				error: function(error){
					console.log("error")
					console.log(error)
				}
			})

	});
/*
hover tooltip
     tooltips:{
     	callbacks:{
     		label: function(tooltipItem, data) {
            var label = data.labels[tooltipItem.index];
			return label + ', F1 - ' + tooltipItem.yLabel + '    F2 - ' + tooltipItem.xLabel + ')';
     	}
     }

    },e;
*/

</script>
<script>
var vowels_formants_list = []

var stat_text = document.getElementById("stat_text");

function setup(){
// create an audio in

  mic = new p5.AudioIn();
    // users must manually enable their browser microphone for recording to work properly!
  mic.start();
	// create a sound recorder
  recorder = new p5.SoundRecorder();
  // connect the mic to the recorder
  recorder.setInput(mic);

}

function startRecord() {
	if (getAudioContext().state !== 'running') {
    getAudioContext().resume();
	}
   
  // create an empty sound file that we will use to playback the recording
  soundFile = new p5.SoundFile();
  // use the '.enabled' boolean to make sure user enabled the mic (otherwise we'd record silence)
  if (mic.enabled) {
    // Tell recorder to record to a p5.SoundFile which we will use for playback
    recorder.record(soundFile);
    stat_text.textContent = "Recording...";

  }
}

function stopRecord(){
	
	recorder.stop(); // stop recorder, and send the result to soundFile
	stat_text.textContent = "Recording stopped";

	//saveSound(soundFile, "{% static 'vowelchart/recordings/myRecordings.wav' %}"); // save file
}

function playRecord(){
	stat_text.textContent = "Playing Recording...";
	soundFile.play(); // play the result!
	console.log(soundFile.buffer);

}
$(document).ready(function(){
		$("#toFormant").on('click', function(event){
				var soundBlob = soundFile.getBlob();
				console.log(soundBlob);
    			var fd = new FormData();
    			fd.append('audio', soundBlob);
    			fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');
				event.preventDefault();
				stat_text.textContent = "Analyzing Formants";
				$.ajax({
					url: '/formant-analysis/',
					method: 'POST',
					data: fd,
        			contentType: false,
        			processData: false,
					success: function(data){
						console.log(data)
						console.log("success");
						console.log("successful replace");
					},
					error: function(errorData){
						console.log("error");
						console.log(errorData);
					}
				})
			})
		})

</script>

{% endblock %}



